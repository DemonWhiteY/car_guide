# 通信传输模块

## 功能

- 将不同模块的消息转发到目标模块

## 采用方式

- 服务器-客户端模式

其中 `control` 模块为服务器，其余的 `UI`、`LLM`、`Face`、`Gesture` 和 `Voice` 五个模块作为客户端。

- 采用socket通信：源客户端->服务器->目的客户端

## 详细设计

### 模块结构

1. **控制服务器（ControlServer）**
   - 负责启动服务器，监听客户端连接。
   - 接收客户端的身份标识，并将客户端注册到服务器。
   - 处理来自客户端的消息，并将消息路由到目标客户端。
   - 支持动态添加和移除客户端，具有良好的扩展性。

2. **通信对象管理（CommObjects）**
   - 提供单例模式的通信对象管理器，统一管理所有模块的通信实例。
   - 包括UI、LLM、Face、Gesture和Voice模块的通信实例。
   - 提供语音合成功能，将文字转换为语音文件。

3. **客户端基类（BaseClient）**
   - 作为所有客户端模块的基类，提供通用的通信功能。
   - 实现与服务器的连接、消息发送和接收。
   - 提供消息处理的接口，供子类实现特定的消息处理逻辑。

4. **客户端类（UICommunication、LLMCommunication、FaceCommunication、GestureCommunication、VoiceCommunication）**
   - 继承自BaseClient，分别对应不同的模块。
   - 实现特定模块的消息处理逻辑。
   - 封装模块的通信细节，使模块间的通信更加简单和直观。

### 消息处理流程

1. **消息发送**
   - 客户端模块构造消息，包括目标地址、发送方地址和数据内容。
   - 调用send_message方法，将消息发送到服务器。
   - 服务器接收到消息后，解析消息的目标地址。

2. **消息路由**
   - 服务器根据目标地址，将消息转发到相应的客户端。
   - 如果目标客户端存在，服务器将消息发送到目标客户端。
   - 如果目标客户端不存在，服务器记录错误信息。

3. **消息接收**
   - 客户端接收到来自服务器的消息。
   - 客户端解析消息内容，根据消息类型调用相应的处理方法。
   - 处理完成后，客户端可以发送响应消息或执行相应的操作。

### 代码实现细节

1. **服务器启动与连接管理**
   - 控制服务器在指定的主机和端口上启动，开始监听客户端连接。
   - 当客户端连接时，服务器接收客户端的身份标识，并将客户端注册到服务器的客户端列表中。
   - 服务器为每个客户端创建一个线程，用于处理客户端的消息。

2. **消息格式**
   - 消息采用JSON格式，包含目标地址、发送方地址和数据内容。
   - 客户端在发送消息时，将消息封装为JSON格式的字符串。
   - 服务器和客户端在接收消息时，解析JSON格式的字符串，提取消息内容。

3. **消息路由与转发**
   - 服务器根据消息的目标地址，查找对应的客户端。
   - 如果目标客户端存在，服务器将消息发送到目标客户端。
   - 如果目标客户端不存在，服务器记录错误信息，并可选择发送错误响应给发送方。

4. **客户端消息处理**
   - 客户端接收到消息后，解析消息内容，提取发送方地址和数据内容。
   - 根据消息的类型和内容，调用相应的处理方法。
   - 处理方法可以执行特定的操作，如更新UI、处理语音指令等。

## 消息格式

```python
message = {
  'target': target,
  'sender': self.identity,
  'data': data
}
```

其中，`target`为目的地址，`sender`为源地址，取值为 `control`、 `ui`、`llm`、`face`、`gesture` 和 `voice` 。`data`为传输数据。

## 代码目录

```txt
/Control/
├── comm_objects.py         # 通信对象管理
├── base_client.py          # 客户端基类
├── client_classes.py       # 各模块客户端类
├── control.py              # 控制服务器
├── main.py                 # 主程序入口
├── llm_module.py           # LLM模块（发送+接收）
└── ui_module.py            # UI模块（只接收）
```